#cloud-config
repo_update: true
repo_upgrade: all

groups:
  - docker
users:
  - default
  # the docker service account
  - name: docker-service
    groups: docker

packages:
  - python-pip
  - postgresql-client
  - awscli
  - gnupg-agent
  - apt-transport-https
  - cargo
  - libpq-dev
  - jq
  - docker.io

runcmd:
  # install pixi
  - echo "Installing Pixi"
  - export PIXI_HOME=/opt/pixi
  - export HOME=/root
  - curl -fsSL https://pixi.sh/install.sh | bash
  - export PATH=$PIXI_HOME/bin:$PATH
  - ln -s $PIXI_HOME/bin/pixi /usr/local/bin/pixi
  - unset HOME

  # clone repo
  - echo "Cloning the repository"
  - cd /opt
  - git clone https://github.com/${github_organization}/${github_repo}.git
  - cd ${github_repo}
  # FIXME current dev branch
  - git checkout tofu-esther

  # *** WAIT FOR INSTANCE METADATA + IAM ROLE ***
  - echo "Waiting for EC2 metadata service and IAM role..."
  - |
    until curl -sf http://169.254.169.254/latest/meta-data/iam/security-credentials/; do
      echo "Waiting for IAM credentials endpoint... (sleep 5)"
      sleep 5
    done
    echo "âœ… IAM credentials available"

  # tool pathing for root
  - echo "export PATH=\$PATH:$PWD/.pixi/envs/backend/bin" >> /root/.bashrc
  - echo "export KUBECONFIG=$PWD/.kube/config" >> /root/.bashrc


  # install backend tools
  - echo "Setting up backend infra"
  - export PATH=/usr/lib/postgresql/14/bin/:$PATH
  - pixi run -e backend install-tools

  # install backend infra
  - echo "Setting up backend infra"
  - pixi run -e backend setup-infra-cloud

  # populate sample entries
  - echo "Set up DB data"
  - pixi run -e backend setup-db-data-via-k8s-job

  # cleanup decrypted secrets so the cleartext file won't be available on the host
  - echo "Cleaning up decrypted secrets"
  - pixi run -e backend cleanup-decrypted-supabase-cloud-values

  # Done! :)
  - echo "Done!"
